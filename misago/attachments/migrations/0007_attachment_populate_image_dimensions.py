# Generated by Django 4.2.10 on 2025-01-06 13:04
from PIL import Image

from django.db import migrations

from ..filetypes import filetypes


def populate_attachments_dimensions(apps, _):
    Attachment = apps.get_model("misago_attachments", "Attachment")

    queryset = Attachment.objects.exclude(
        filetype_id__isnull=True,
        upload="",
    ).order_by("id")

    for attachment in queryset.iterator(chunk_size=50):
        filetype = filetypes.get_filetype(attachment.filetype_id)
        if not filetype.is_image or not attachment.upload:
            continue

        image = Image.open(attachment.upload.path)
        attachment.dimensions = "x".join(map(str, image.size))
        del image

        if attachment.thumbnail:
            image = Image.open(attachment.thumbnail.path)
            attachment.thumbnail_dimensions = "x".join(map(str, image.size))
            del image

        attachment.save(update_fields=["dimensions", "thumbnail_dimensions"])



class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("misago_attachments", "0006_attachment_populate_thumbnail_size"),
    ]

    operations = [
        migrations.RunPython(
            populate_attachments_dimensions,
            migrations.RunPython.noop,
        ),
    ]
